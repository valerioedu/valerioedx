#include <ramfb.h>
#include <fwcfg.h>

// 8x8 bitmap font for ASCII
const u8 font8x8_basic[128][8] = {
    [' '] = {
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
    },
    ['!'] = {
        0b00011000,
        0b00011000,
        0b00011000,
        0b00011000,
        0b00011000,
        0b00000000,
        0b00011000,
        0b00000000,
    },['.'] = {
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00011000,
        0b00000000,
    },
    ['A'] = {
        0b00011000,
        0b00100100,
        0b01000010,
        0b01000010,
        0b01111110,
        0b01000010,
        0b01000010,
        0b00000000,
    },
    ['B'] = {
        0b01111100,
        0b01000010,
        0b01000010,
        0b01111100,
        0b01000010,
        0b01000010,
        0b01111100,
        0b00000000,
    },
    ['C'] = {
        0b00111100,
        0b01000010,
        0b01000000,
        0b01000000,
        0b01000000,
        0b01000010,
        0b00111100,
        0b00000000,
    },
    ['D'] = {
        0b01111000,
        0b01000100,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01000100,
        0b01111000,
        0b00000000,
    },
    ['E'] = {
        0b01111110,
        0b01000000,
        0b01000000,
        0b01111100,
        0b01000000,
        0b01000000,
        0b01111110,
        0b00000000,
    },
    ['F'] = {
        0b01111110,
        0b01000000,
        0b01000000,
        0b01111100,
        0b01000000,
        0b01000000,
        0b01000000,
        0b00000000,
    },
    ['G'] = {
        0b00111100,
        0b01000010,
        0b01000000,
        0b01001110,
        0b01000010,
        0b01000010,
        0b00111100,
        0b00000000,
    },
    ['H'] = {
        0b01000010,
        0b01000010,
        0b01000010,
        0b01111110,
        0b01000010,
        0b01000010,
        0b01000010,
        0b00000000,
    },
    ['I'] = {
        0b00111100,
        0b00011000,
        0b00011000,
        0b00011000,
        0b00011000,
        0b00011000,
        0b00111100,
        0b00000000,
    },
    ['J'] = {
        0b00011110,
        0b00000100,
        0b00000100,
        0b00000100,
        0b01000100,
        0b01000100,
        0b00111000,
        0b00000000,
    },
    ['K'] = {
        0b01000010,
        0b01000100,
        0b01001000,
        0b01110000,
        0b01001000,
        0b01000100,
        0b01000010,
        0b00000000,
    },
    ['L'] = {
        0b01000000,
        0b01000000,
        0b01000000,
        0b01000000,
        0b01000000,
        0b01000000,
        0b01111110,
        0b00000000,
    },
    ['M'] = {
        0b01000010,
        0b01100110,
        0b01011010,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01000010,
        0b00000000,
    },
    ['N'] = {
        0b01000010,
        0b01100010,
        0b01010010,
        0b01001010,
        0b01000110,
        0b01000010,
        0b01000010,
        0b00000000,
    },
    ['O'] = {
        0b00111100,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01000010,
        0b00111100,
        0b00000000,
    },
    ['P'] = {
        0b01111100,
        0b01000010,
        0b01000010,
        0b01111100,
        0b01000000,
        0b01000000,
        0b01000000,
        0b00000000,
    },
    ['Q'] = {
        0b00111100,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01001010,
        0b01000110,
        0b00111110,
        0b00000000,
    },
    ['R'] = {
        0b01111100,
        0b01000010,
        0b01000010,
        0b01111100,
        0b01001000,
        0b01000100,
        0b01000010,
        0b00000000,
    },
    ['S'] = {
        0b00111100,
        0b01000010,
        0b01000000,
        0b00111100,
        0b00000010,
        0b01000010,
        0b00111100,
        0b00000000,
    },
    ['T'] = {
        0b01111110,
        0b00011000,
        0b00011000,
        0b00011000,
        0b00011000,
        0b00011000,
        0b00011000,
        0b00000000,
    },
    ['U'] = {
        0b01000010,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01000010,
        0b00111100,
        0b00000000,
    },
    ['V'] = {
        0b01000010,
        0b01000010,
        0b01000010,
        0b00100100,
        0b00100100,
        0b00011000,
        0b00011000,
        0b00000000,
    },
    ['W'] = {
        0b01000010,
        0b01000010,
        0b01000010,
        0b01011010,
        0b01011010,
        0b01100110,
        0b01000010,
        0b00000000,
    },
    ['X'] = {
        0b01000010,
        0b00100100,
        0b00011000,
        0b00011000,
        0b00011000,
        0b00100100,
        0b01000010,
        0b00000000,
    },
    ['Y'] = {
        0b01000010,
        0b00100100,
        0b00011000,
        0b00011000,
        0b00011000,
        0b00011000,
        0b00011000,
        0b00000000,
    },
    ['Z'] = {
        0b01111110,
        0b00000010,
        0b00000100,
        0b00001000,
        0b00010000,
        0b00100000,
        0b01111110,
        0b00000000,
    },
};

/* 1366*768*4 = 4,196,000 bytes (~4.2MB) */
u32 fb_buffer[WIDTH * HEIGHT]; 

static inline void put_pixel(int x, int y, u32 color) {
    if (x < 0 || x >= WIDTH || y < 0 || y >= HEIGHT) return;
    fb_buffer[y * WIDTH + x] = color;
}

static void draw_char_bitmap(int x, int y, char c, u32 fg, u32 bg) {
    const int cw = 8;
    const int ch = 8;

    const u8 *glyph = font8x8_basic[(unsigned char)c];

    for (int row = 0; row < ch; row++) {
        u8 bits = glyph[row];
        for (int col = 0; col < cw; col++) {
            u32 color = (bits & (1 << (7 - col))) ? fg : bg;
            put_pixel(x + col, y + row, color);
        }
    }
}

void draw_string_bitmap(int x, int y, const char *s, u32 fg, u32 bg) {
    const int cw = 8;
    while (*s) {
        draw_char_bitmap(x, y, *s, fg, bg);
        x += cw;
        s++;
    }
}

void ramfb_init() {
    u16 select = find_ramfb_file();
    if (select == 0) return; 

    RamfbCfg cfg;
    cfg.addr = bswap64((u64)fb_buffer);
    
    /* XR24 (XRGB8888) is the most standard format for QEMU. */
    /* 'X','R','2','4' -> 0x34325258 (Little Endian) */
    cfg.fourcc = bswap32(0x34325258); 
    
    cfg.flags = bswap32(0);
    cfg.width = bswap32(WIDTH);
    cfg.height = bswap32(HEIGHT);
    cfg.stride = bswap32(WIDTH * 4);

    fw_cfg_dma(FW_CFG_DMA_CTL_WRITE | FW_CFG_DMA_CTL_SELECT | (select << 16), &cfg, sizeof(cfg));
}